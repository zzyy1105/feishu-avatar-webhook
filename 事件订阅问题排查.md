# 飞书事件订阅问题最终排查方案

## 当前状态
- ✅ Webhook验证成功
- ✅ 应用已添加到多维表格
- ✅ 事件已订阅
- ✅ 应用已发布
- ❌ 修改表格后没有收到事件

---

## 可能的原因

### 原因1：事件订阅的scope问题

飞书的事件订阅有两种scope：
- **应用级别**：应用被添加到任何多维表格都能收到事件
- **用户级别**：只能收到特定用户的操作事件

**检查方法：**
1. 飞书开放平台 → 事件订阅
2. 查看"订阅方式"或"Scope"
3. 必须是"应用身份订阅"或"tenant"

---

### 原因2：事件版本不匹配

你订阅的是：
- 多维表格记录变更v2.0
- 多维表格字段变更v2.0

但代码中监听的事件类型可能不匹配。

**v2.0事件的类型名称可能是：**
- `bitable.app_table_record.changed_v2`
- `bitable_app_table_record_changed_v2`

---

### 原因3：应用未在多维表格的"应用列表"中

添加为协作者 ≠ 添加为应用

**检查方法：**
1. 打开多维表格
2. 点击右上角 **"..."** → **"高级设置"** → **"应用"**
3. 查看应用列表中是否有你的应用

---

### 原因4：事件推送延迟或失败

飞书可能因为网络问题推送失败。

**检查方法：**
1. 飞书开放平台 → 事件订阅
2. 查看是否有"推送记录"或"事件日志"
3. 查看推送状态

---

## 立即测试方案

### 方案A：使用curl手动发送测试事件

在命令行执行：

```bash
curl -X POST https://feishu-avatar-webhook.onrender.com/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "type": "event_callback",
    "token": "test",
    "event": {
      "type": "bitable.app_table_record.changed",
      "app_token": "FbU2bnPIPawHQvsIMudcANvwnWf",
      "table_id": "tblp5MrI71tKK7wq",
      "record_id": "test123"
    }
  }'
```

然后查看Render日志，应该看到：
```
收到Webhook请求
请求类型: event_callback
事件类型: bitable.app_table_record.changed
```

---

### 方案B：检查飞书事件推送日志

1. 飞书开放平台 → 事件订阅
2. 查找"推送记录"、"事件日志"或"调试"选项
3. 查看最近的推送记录
4. 如果没有推送记录，说明飞书根本没有发送事件

---

### 方案C：重新配置事件订阅

1. 飞书开放平台 → 事件订阅
2. **删除现有的事件订阅**
3. **重新添加**：
   - 搜索"多维表格"
   - 选择"多维表格记录变更"（不带v2.0后缀的版本）
4. 保存
5. **创建新版本并发布**
6. 等待2分钟
7. 修改表格测试

---

## 终极测试

如果以上都不行，请执行：

### 第1步：确认事件类型

告诉我：
1. 在飞书开放平台 → 事件订阅 → 已订阅事件中
2. 每个事件的**完整名称**是什么？
3. 是否有"事件类型"或"event_type"字段？

### 第2步：查看飞书推送日志

1. 修改多维表格
2. 立即去飞书开放平台查看是否有推送记录
3. 如果有推送记录但Render没收到，说明是网络问题
4. 如果没有推送记录，说明是配置问题

### 第3步：联系我

告诉我：
1. 事件订阅页面的截图
2. 修改表格后，飞书是否有推送记录
3. Render日志的完整输出

---

## 快速诊断命令

在你的电脑上运行（测试Webhook是否能接收）：

```bash
curl -X POST https://feishu-avatar-webhook.onrender.com/webhook -H "Content-Type: application/json" -d "{\"type\":\"event_callback\",\"event\":{\"type\":\"test\"}}"
```

如果Render日志有反应，说明服务正常，问题在飞书配置。
