# 完整部署步骤（手把手教程）

## 第一步：准备GitHub仓库（5分钟）

### 1.1 创建GitHub仓库

1. 访问 https://github.com
2. 点击右上角 "+" → "New repository"
3. 填写信息：
   - Repository name: `feishu-avatar-webhook`
   - Description: `飞书群头像自动更新`
   - 选择 `Public`（公开）
   - ✅ 勾选 "Add a README file"
4. 点击 "Create repository"

### 1.2 上传代码到GitHub

**方法A：使用Git命令行（推荐）**

打开命令提示符，进入项目目录：

```bash
cd E:\AI\修改头像

# 初始化Git仓库
git init

# 添加所有文件
git add .

# 提交
git commit -m "Initial commit"

# 关联远程仓库（替换成你的GitHub用户名）
git remote add origin https://github.com/你的用户名/feishu-avatar-webhook.git

# 推送到GitHub
git branch -M main
git push -u origin main
```

**方法B：使用GitHub Desktop（简单）**

1. 下载安装 [GitHub Desktop](https://desktop.github.com/)
2. 登录GitHub账号
3. File → Add Local Repository → 选择 `E:\AI\修改头像`
4. Publish repository

**方法C：直接上传（最简单）**

1. 进入你的GitHub仓库页面
2. 点击 "uploading an existing file"
3. 将 `E:\AI\修改头像` 下的所有文件拖拽上传
4. 点击 "Commit changes"

---

## 第二步：部署到Render.com（10分钟）

### 2.1 注册Render账号

1. 访问 https://render.com
2. 点击 "Get Started"
3. 选择 "Sign in with GitHub"（用GitHub登录）
4. 授权Render访问你的GitHub

### 2.2 创建Web Service

1. 登录后点击 "New +" → "Web Service"
2. 找到你的仓库 `feishu-avatar-webhook`，点击 "Connect"
3. 填写配置：

**基本信息：**
- Name: `feishu-avatar-webhook`（或任意名称）
- Region: `Singapore`（新加坡，离中国最近）
- Branch: `main`
- Root Directory: 留空
- Runtime: `Python 3`

**构建命令：**
```
pip install -r requirements.txt
```

**启动命令：**
```
gunicorn -w 4 -b 0.0.0.0:$PORT --timeout 120 webhook_server_hybrid:app
```

**计划：**
- Instance Type: `Free`

4. 点击 "Create Web Service"

### 2.3 等待部署

- 首次部署需要3-5分钟
- 可以在 "Logs" 标签查看部署进度
- 部署成功后会显示：`Your service is live 🎉`

### 2.4 获取服务URL

部署成功后，在页面顶部会显示你的服务URL，例如：
```
https://feishu-avatar-webhook.onrender.com
```

**记下这个URL，后面会用到！**

### 2.5 测试服务

在浏览器访问：
```
https://你的服务.onrender.com/health
```

应该看到：
```json
{
  "status": "ok",
  "timestamp": "2026-02-02T...",
  "processed_count": 0,
  "mode": "hybrid (webhook + polling)"
}
```

✅ 如果看到这个，说明部署成功！

---

## 第三步：配置UptimeRobot保活（5分钟）

### 3.1 注册UptimeRobot

1. 访问 https://uptimerobot.com
2. 点击 "Sign Up Free"
3. 填写邮箱、密码，注册账号
4. 验证邮箱

### 3.2 创建监控

1. 登录后点击 "+ Add New Monitor"
2. 填写信息：
   - Monitor Type: `HTTP(s)`
   - Friendly Name: `飞书头像服务`
   - URL: `https://你的服务.onrender.com/health`
   - Monitoring Interval: `5 minutes`
3. 点击 "Create Monitor"

✅ 完成！现在每5分钟会自动ping一次，防止服务休眠

---

## 第四步：配置飞书Webhook（10分钟）

### 4.1 获取Verification Token

1. 访问 https://open.feishu.cn/
2. 进入你的应用
3. 左侧菜单 → "事件订阅"
4. 复制 "Verification Token"

### 4.2 更新代码

在Render控制台：
1. 点击 "Environment" 标签
2. 添加环境变量：
   - Key: `VERIFICATION_TOKEN`
   - Value: `粘贴你的token`
3. 点击 "Save Changes"

或者直接修改GitHub代码中的 `webhook_server_hybrid.py`：
```python
VERIFICATION_TOKEN = "你的token"
```
然后推送到GitHub，Render会自动重新部署。

### 4.3 配置事件订阅

在飞书开放平台：

1. **请求地址配置：**
   - 请求地址URL: `https://你的服务.onrender.com/webhook`
   - 点击 "验证"
   - 看到 "验证成功" ✅

2. **添加事件订阅：**
   - 点击 "添加事件"
   - 搜索 "多维表格"
   - 勾选：`多维表格记录变更` (bitable.app_table_record.changed)
   - 点击 "确定"

3. **确认权限：**
   确保应用已开通以下权限：
   - ✅ `bitable:app` - 查看、编辑多维表格
   - ✅ `im:chat` - 获取与更新群组信息
   - ✅ `im:resource` - 上传图片

4. **发布版本：**
   - 点击右上角 "创建版本"
   - 填写版本说明
   - 点击 "保存并发布"
   - 等待审核通过（通常几分钟）

---

## 第五步：测试完整流程（5分钟）

### 5.1 准备测试

1. 确保多维表格中有测试数据
2. 确保有对应的飞书群
3. 确保群组字段填写了正确的chat_id

### 5.2 执行测试

1. 打开多维表格
2. 找到一条记录
3. 将"发机通道申请状态"改为"已通过"
4. 保存

### 5.3 查看结果

**方式1：查看Render日志**
- 进入Render控制台
- 点击 "Logs" 标签
- 应该看到类似：
```
[Webhook] 收到请求
[Webhook] 条件满足，更新群头像: oc_xxx
[Webhook] 成功更新群 oc_xxx 的头像
```

**方式2：查看飞书群**
- 打开对应的飞书群
- 查看群头像是否已更新

✅ 如果头像更新了，说明一切正常！

---

## 🎉 部署完成！

现在你的服务已经：
- ✅ 部署到云端，7x24小时运行
- ✅ 配置了保活监控，避免休眠
- ✅ 接入飞书Webhook，实时响应
- ✅ 定时轮询兜底，100%可靠

## 📊 后续维护

### 查看日志
```
Render控制台 → Logs
```

### 更新代码
```bash
git add .
git commit -m "更新"
git push
```
推送后Render会自动重新部署

### 更换头像
1. 替换GitHub仓库中的 `avatar.jpg`
2. 推送更新
3. Render自动部署

### 监控服务状态
- UptimeRobot会发送邮件通知服务异常
- Render控制台可查看运行状态

## ❓ 常见问题

### Q: 部署失败怎么办？
A: 查看Render的Logs标签，根据错误信息排查

### Q: Webhook验证失败？
A: 检查VERIFICATION_TOKEN是否正确配置

### Q: 头像没有更新？
A: 
1. 检查Render日志
2. 确认chat_id正确
3. 确认应用权限完整

### Q: 服务休眠了怎么办？
A: 
1. 确认UptimeRobot正在运行
2. 即使休眠，5分钟内轮询也会处理

---

需要我帮你执行哪一步？我可以：
1. 帮你生成Git命令
2. 指导GitHub上传
3. 协助Render配置
4. 帮你测试服务
