# 混合模式部署指南

## 什么是混合模式？

结合 **Webhook实时响应** 和 **定时轮询** 两种方式：
- ✅ 正常情况：Webhook实时响应（0延迟）
- ✅ 服务休眠时：定时轮询兜底（最多5分钟延迟）
- ✅ 自动去重：避免重复处理

## 部署步骤

### 1. 使用混合模式代码

将 `webhook_server_hybrid.py` 重命名为 `webhook_server.py`：

```bash
# Windows
move webhook_server.py webhook_server_old.py
move webhook_server_hybrid.py webhook_server.py

# Linux/Mac
mv webhook_server.py webhook_server_old.py
mv webhook_server_hybrid.py webhook_server.py
```

或者修改启动命令为：
```bash
gunicorn -w 4 -b 0.0.0.0:$PORT webhook_server_hybrid:app
```

### 2. 部署到Render

按照 `Render部署指南.md` 正常部署即可

### 3. 配置UptimeRobot保活（可选但推荐）

1. 注册 https://uptimerobot.com
2. 创建监控：
   - URL: `https://你的服务.onrender.com/health`
   - 间隔: 5分钟
3. 这样可以最大程度避免休眠

### 4. 配置飞书Webhook

正常配置即可，即使偶尔休眠，轮询也会兜底

## 工作原理

```
用户修改表格
    ↓
飞书推送Webhook ──→ 服务在线 ──→ 立即更新 ✅
    ↓
    └──→ 服务休眠 ──→ Webhook丢失
                        ↓
                   5分钟内轮询检测 ──→ 更新 ✅
```

## 优势

| 特性 | 纯Webhook | 纯轮询 | 混合模式 |
|------|-----------|--------|----------|
| 实时性 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 可靠性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 资源消耗 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 成本 | ¥0 | ¥0 | ¥0 |

## 监控

访问 `/health` 可以看到：
```json
{
  "status": "ok",
  "timestamp": "2024-xx-xx...",
  "processed_count": 5,
  "mode": "hybrid (webhook + polling)"
}
```

## 手动触发检查

```bash
curl -X POST https://你的服务.onrender.com/force-check
```

## 日志

- Webhook事件会标记 `[Webhook]`
- 轮询事件会标记 `[轮询]`
- 方便区分触发方式

## 推荐配置

**最佳实践：**
1. 部署混合模式到Render
2. 配置UptimeRobot保活
3. 设置飞书Webhook

**效果：**
- 99%的情况实时响应
- 1%的情况5分钟内响应
- 总成本：¥0
